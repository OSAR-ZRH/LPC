
<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Audio‚ÄìBild & Funk ‚Äì LPC-Test (Deutsch H√∂rverstehen)</title>
<style>
  :root{--bg:#f7f9fc;--card:#fff;--ink:#0f172a;--muted:#5b6b8c;--acc:#2563eb;--bar:#e8eef9;--barfill:#c7d7f7;--warn:#f59e0b;--ok:#16a34a;--bad:#ef4444;--shadow:0 6px 18px rgba(15,23,42,.08)}
  *{box-sizing:border-box}
  body{margin:0;font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,sans-serif;background:var(--bg);color:var(--ink)}
  header{padding:16px 20px;background:#fff;border-bottom:1px solid #e6eef8;position:sticky;top:0;z-index:10;box-shadow:0 2px 10px rgba(15,23,42,.05);display:flex;align-items:center;justify-content:space-between;gap:10px}
  h1{margin:0;font-size:18px}
  main{max-width:1000px;margin:0 auto;padding:20px}
  .card{background:var(--card);border:1px solid #e6eef8;border-radius:14px;padding:16px;margin-bottom:20px;box-shadow:var(--shadow)}
  .muted{color:var(--muted);font-size:14px}
  button{border:1px solid #c7d7f7;background:#ecf3ff;color:var(--ink);padding:10px 14px;border-radius:10px;cursor:pointer;transition:.15s;font-weight:600}
  button.primary{background:var(--acc);border-color:#1e4ed8;color:#fff}
  button.ghost{background:#fff;border-color:#e6eef8}
  button:disabled{opacity:.6;cursor:not-allowed}
  button:hover:not(:disabled){transform:translateY(-1px)}
  .pill{display:inline-block;padding:4px 10px;border-radius:999px;border:1px solid #d6e4ff;background:#f1f5ff;font-size:12px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .hidden{display:none}
  .rules{display:grid;gap:10px;margin:10px 0 0}
  .rules .item{display:flex;gap:10px;align-items:flex-start}
  .rules .badge{min-width:18px;width:18px;height:18px;border-radius:999px;background:#eaf2ff;border:1px solid #d6e4ff;display:grid;place-items:center;font-weight:700;color:#1f3b72;font-size:11px}
  .center{text-align:center}
  .timer{height:6px;background:var(--bar);border:1px solid #c7d7f7;border-radius:999px;overflow:hidden;margin:8px 0 4px;width:100%}
  .timer .bar{height:100%;width:100%;background:var(--barfill);transition:width .2s linear}
  .timer .bar.warn{background:var(--warn)}
  .choices{display:grid;gap:14px;margin-top:14px}
  @media(min-width:860px){.choices.grid3{grid-template-columns:repeat(3,1fr)}}
  .opt{background:#f8fbff;border:2px solid #dbe7ff;border-radius:12px;padding:10px;cursor:pointer;transition:.15s}
  .opt.selected{border-color:var(--acc); box-shadow:0 0 0 3px rgba(37,99,235,.20)}
  .svg-wrap{width:100%;aspect-ratio:1/1;background:#f4f8ff;border:1px solid #e3edff;border-radius:10px;display:grid;place-items:center}
  .label-center{text-align:center;margin-top:6px;color:var(--muted)}
  .mcq{display:grid;gap:10px;margin-top:12px}
  .mcq .choice{display:flex;gap:10px;align-items:flex-start;border:2px solid #dbe7ff;background:#f8fbff;padding:10px 12px;border-radius:10px;cursor:pointer}
  .mcq .choice.selected{border-color:var(--acc); box-shadow:0 0 0 3px rgba(94,161,255,.28)}
  .result-pass{border:1px solid #b7ead3;background:#ecfdf5;color:#065f46;padding:12px;border-radius:12px}
  .result-fail{border:1px solid #fecaca;background:#fef2f2;color:#7f1d1d;padding:12px;border-radius:12px}
  .list{margin-top:10px;border-top:1px dashed #e6eef8;padding-top:10px}
  .list-item{display:flex;justify-content:space-between;gap:8px;padding:6px 0;border-bottom:1px dashed #e6eef8}
  .modal-backdrop{position:fixed;inset:0;background:rgba(15,23,42,.28);backdrop-filter:blur(2px);display:none;align-items:center;justify-content:center;z-index:50}
  .modal{background:#fff;border:1px solid #e6eef8;border-radius:14px;box-shadow:var(--shadow);max-width:640px;width:94%;padding:16px}
  .grid{display:grid;gap:10px}
  .grid.cols2{grid-template-columns:1fr 1fr}
  .field{display:grid;gap:6px}
  select, input[type="range"]{padding:8px 10px;border:1px solid #dbe7ff;border-radius:10px;background:#f8fbff}
  .help{font-size:12px;color:var(--muted)}
  .toast{position:fixed;right:16px;bottom:16px;background:#111827;color:#fff;padding:10px 12px;border-radius:10px;box-shadow:var(--shadow);z-index:100;max-width:420px;font-size:13px;display:none}
</style>
</head>
<body>
<header>
  <h1>Audio‚ÄìBild & Funk ‚Äì LPC-Test (Deutsch H√∂rverstehen)</h1>
  <button id="openSettings" class="ghost" type="button">‚öôÔ∏è Audio‚ÄëEinstellungen</button>
</header>

<!-- Settings Modal -->
<div id="settingsBackdrop" class="modal-backdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="settingsTitle">
    <div class="row" style="justify-content:space-between">
      <h3 id="settingsTitle">Audio-Einstellungen</h3>
      <button id="closeSettings" class="ghost" type="button">‚úñ</button>
    </div>
    <div class="grid">
      <div class="field">
        <label for="voiceSelect"><b>Stimme (de-DE)</b></label>
        <select id="voiceSelect" aria-label="Stimme w√§hlen"></select>
        <div class="help">Tipp: W√§hle eine <b>Online/Natural</b>-Stimme (Edge: <code>edge://voices/</code>).</div>
      </div>
      <div class="grid cols2">
        <div class="field">
          <label for="rate"><b>Sprechgeschwindigkeit</b> <span id="rateVal" class="help"></span></label>
          <input id="rate" type="range" min="0.7" max="1.2" step="0.01" value="1.0">
        </div>
        <div class="field">
          <label for="pitch"><b>Tonh√∂he</b> <span id="pitchVal" class="help"></span></label>
          <input id="pitch" type="range" min="0.8" max="1.2" step="0.01" value="1.0">
        </div>
      </div>
      <div class="row" style="justify-content:flex-end">
        <button id="testVoice" type="button">Stimme testen</button>
        <button id="saveVoice" class="primary" type="button">Speichern</button>
      </div>
      <div class="help">Die Auswahl wird lokal gespeichert und im Test verwendet.</div>
    </div>
  </div>
</div>

<main>
  <!-- Start Page -->
  <section class="card" id="startCard">
    <h2>Willkommen zum LPC-Test üëã</h2>
    <p>Dieser Test pr√ºft dein <b>deutsches H√∂rverst√§ndnis</b> mit kurzen Ansagen und Funkspr√ºchen.</p>
    <div class="rules">
      <div class="item"><div class="badge">1</div><div>Es gibt <b>15 Fragen</b> in <b>zuf√§lliger Reihenfolge</b>: Bild-Aufgaben mit Ansage und Funk-Aufgaben mit Textantwort.</div></div>
      <div class="item"><div class="badge">2</div><div>Du hast pro Frage <b>30 Sekunden</b>. Die Zeitleiste zeigt die Zeit. L√§uft sie ab, z√§hlt die Frage als <b>falsch</b>.</div></div>
      <div class="item"><div class="badge">3</div><div>Die Ansage startet <b>automatisch</b> und kann pro Frage noch <b>einmal</b> wiederholt werden (insgesamt 2√ó).</div></div>
      <div class="item"><div class="badge">4</div><div>Du bestehst mit mindestens <b>90&nbsp;% bzw. 14 richtigen Antworten</b>.</div></div>
      <div class="item"><div class="badge">5</div><div>W√§hrend des Tests gibt es <b>keine Aufl√∂sung</b>. Alle richtigen Antworten siehst du am <b>Ende</b>.</div></div>
    </div>
    <div class="center" style="margin-top:14px; display:flex; gap:10px; justify-content:center; flex-wrap:wrap;">
      <button id="practiceBtn" type="button">üß™ √úbungsrunde (2 Fragen)</button>
      <button id="startBtn" class="primary" type="button">üöÄ LPC-Test starten</button>
    </div>
  </section>

  <!-- Practice -->
  <section class="card hidden" id="practiceCard">
    <div class="row"><div class="pill">√úbung</div><div class="pill">2 Fragen</div></div>
    <p class="muted">Die √úbungsrunde z√§hlt nicht zur Wertung. Du siehst keine Aufl√∂sung w√§hrend der Fragen.</p>
    <div class="row" style="margin:10px 0">
      <button id="p_play" type="button">üîÅ Ansage wiederholen</button>
      <button id="p_submit" type="button">Antwort abgeben</button>
      <button id="p_next" type="button" disabled>N√§chste ‚ûú</button>
    </div>
    <div class="timer"><div class="bar" id="p_timeBar"></div></div>
    <div class="row" style="gap:10px;margin-top:6px">
      <div class="pill">Audio √ºbrig: <b id="p_playsLeft">1</b></div>
      <div class="pill">Zeit: <b id="p_timeLeft">30s</b></div>
      <div class="pill">Frage <b id="p_idx">1</b>/<span id="p_total">2</span></div>
    </div>

    <div id="p_prompt" style="font-weight:600; margin-top:8px"></div>
    <div id="p_imageChoices" class="choices grid3 hidden"></div>
    <div id="p_mcqChoices" class="mcq hidden"></div>
    <div id="p_feedback" style="margin-top:12px"></div>

    <div class="center" style="margin-top:12px">
      <button id="toTestBtn" class="primary hidden" type="button">LPC-Test starten</button>
    </div>
  </section>

  <!-- Test -->
  <section class="card hidden" id="quizCard">
    <div class="row">
      <div class="pill">Frage <b id="idx">1</b>/<span id="total">15</span></div>
      <div class="pill hidden">Richtig: <b id="score">0</b></div>
      <div class="pill">Audio √ºbrig: <b id="playsLeft">1</b></div>
      <div class="pill">Zeit: <b id="timeLeft">30s</b></div>
    </div>
    <div class="timer"><div class="bar" id="timeBar"></div></div>
    <p class="muted">H√∂re die <b>Ansage</b> oder den <b>Funkspruch</b> (max. 2√ó je Frage) und w√§hle die passende Antwort. Pro Frage hast du <b>30 Sekunden</b>.</p>
    <div class="row" style="margin:10px 0">
      <button id="play" type="button">üîÅ Ansage wiederholen</button>
      <button id="submit" type="button">Antwort abgeben</button>
      <button id="next" type="button" disabled>N√§chste Frage ‚ûú</button>
    </div>
    <div id="prompt" style="font-weight:600"></div>

    <div id="imageChoices" class="choices grid3 hidden"></div>
    <div id="mcqChoices" class="mcq hidden" role="radiogroup" aria-label="Antwortm√∂glichkeiten"></div>

    <div id="feedback" style="margin-top:12px"></div>
  </section>

  <!-- Summary -->
  <section class="card hidden" id="summaryCard">
    <h2>üìä Auswertung ‚Äì LPC-Test</h2>
    <div id="summaryBox"></div>
    <div class="list" id="detailList"></div>
    <div class="row" style="margin-top:12px">
      <button id="restart" type="button">Nochmal starten</button>
    </div>
  </section>
</main>

<div id="toast" class="toast"></div>

<script>
// ---------- toast helper ----------
function toast(msg){ try{const t=document.getElementById('toast'); t.textContent=msg; t.style.display='block'; setTimeout(()=>{t.style.display='none';}, 3500);}catch(e){} }

// ---------- DOM ready ----------
if (document.readyState === 'loading'){ document.addEventListener('DOMContentLoaded', init); } else { init(); }

function init(){
try{
// ---------- constants ----------
const PASS_THRESHOLD=0.90, MAX_PLAYS=2, TIME_LIMIT=30;

// ---------- helpers ----------
function shuffle(a){ const arr=a.slice(); for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]];} return arr; }
function el(name, attrs={}, children=[]){ const e=document.createElementNS("http://www.w3.org/2000/svg", name); for(const k in attrs){ e.setAttribute(k, attrs[k]); } for(const c of children){ e.appendChild(c); } return e;}
function drawBase(w=220,h=220){ const svg=el("svg",{viewBox:`0 0 ${w} ${h}`,width:"92%",height:"92%"}); return svg; }
function addRect(svg,x,y,w,h,fill,stroke=null,sw=3,rx=10){ svg.appendChild(el("rect",{x,y,width:w,height:h,fill,rx,ry:rx,stroke:stroke||"none","stroke-width":sw})); }
function addCircle(svg,cx,cy,r,fill,stroke=null,sw=3){ svg.appendChild(el("circle",{cx,cy,r,fill,stroke:stroke||"none","stroke-width":sw})); }
function addLine(svg,x1,y1,x2,y2,stroke,sw=8){ svg.appendChild(el("line",{x1,y1,x2,y2,stroke,"stroke-width":sw,"stroke-linecap":"round"})); }
function addTriangle(svg,points,fill,stroke=null,sw=3){ svg.appendChild(el("polygon",{points,fill,stroke:stroke||"none","stroke-width":sw})); }
function addText(svg,x,y,text,fill="#1f2937",size=20,weight="700"){ const t=el("text",{x,y,fill,"font-size":size,"font-weight":weight}); t.textContent=text; svg.appendChild(t); }
const colors={ red:"#e74c3c", blue:"#3498db", green:"#2ecc71", yellow:"#f1c40f", violet:"#9b59b6", orange:"#e67e22", teal:"#1abc9c", white:"#ecf0f1" };

// ---------- TTS / Stimmen ----------
let cachedDeVoice=null;
const LS_KEY="lpc_voice_pref_v1";
function awaitVoices(timeout=1200){ return new Promise(res=>{ try{ const have=speechSynthesis?.getVoices?.()||[]; if(have.length) return res(have); let done=false; const on=()=>{ if(!done){done=true; speechSynthesis.removeEventListener('voiceschanged',on); res(speechSynthesis.getVoices()); } }; speechSynthesis?.addEventListener('voiceschanged',on); setTimeout(()=>{ if(!done){done=true; speechSynthesis?.removeEventListener('voiceschanged',on); res(speechSynthesis?.getVoices?.()||[]);} },timeout);}catch{res([])} });}
function pickGerman(voices){ if(!voices.length) return null; const byName=s=>voices.find(v=>(v.name||"").toLowerCase().includes(s)); const byLang=c=>voices.find(v=>(v.lang||"").toLowerCase().startsWith(c)); const prefer=["natural (de","online (natural) (de","microsoft katja","microsoft conrad","microsoft amelie","microsoft hedy"]; for(const k of prefer){ const v=byName(k); if(v && (v.lang||"").toLowerCase().startsWith("de")) return v; } return byLang("de-de")||byLang("de-")||null; }
function loadPref(){ try{ return JSON.parse(localStorage.getItem(LS_KEY)||"null"); }catch{return null} }
function savePref(p){ try{ localStorage.setItem(LS_KEY, JSON.stringify(p)); }catch{} }
async function getDeVoice(){ if(cachedDeVoice) return cachedDeVoice; const saved=loadPref(); const vs=await awaitVoices(); if(saved?.name){ const m=vs.find(v=>v.name===saved.name); if(m){ cachedDeVoice=m; return m; } } cachedDeVoice=pickGerman(vs); return cachedDeVoice; }
async function speak(text){ if(!('speechSynthesis' in window) || !text) return; try{ speechSynthesis.cancel(); const u=new SpeechSynthesisUtterance(text); u.lang='de-DE'; const pref=loadPref(); const v=await getDeVoice(); if(v) u.voice=v; u.rate=pref?.rate??1.0; u.pitch=pref?.pitch??1.0; speechSynthesis.speak(u);}catch(e){ console.warn(e); } }
function playPrompt(s){ if(s?.audioSrc){ const a=new Audio(s.audioSrc); a.play().catch(()=>speak(s.tts)); } else { speak(s.tts); } }

// ---------- Szenarien (voll) ----------
// 5 Bild-Basis
const imageBase=[
  { kind:"image", prompt:"",
    tts:"W√§hle das Bild mit einem roten Kreis oben links und einer blauen diagonalen Linie von unten links nach oben rechts.",
    buildOptions:function(){ const o=[];
      o.push({correct:true, svg:()=>{const s=drawBase();addCircle(s,60,60,32,colors.red);addLine(s,30,190,190,30,colors.blue,10);return s;}});
      o.push({correct:false, svg:()=>{const s=drawBase();addCircle(s,160,60,32,colors.red);addLine(s,30,190,190,30,colors.blue,10);return s;}});
      o.push({correct:false, svg:()=>{const s=drawBase();addCircle(s,60,60,32,colors.red);addLine(s,30,30,190,180,colors.blue,10);return s;}});
      return shuffle(o);
    }},
  { kind:"image", prompt:"",
    tts:"Suche das Bild mit einem gelben Rechteck in der Mitte, einem gr√ºnen Dreieck unten und einer violetten senkrechten Linie rechts.",
    buildOptions:function(){ const tri=(cx,cy,w,h)=>`${cx-w/2},${cy} ${cx+w/2},${cy} ${cx},${cy-h}`; const o=[];
      o.push({correct:true, svg:()=>{const s=drawBase();addRect(s,60,70,100,70,colors.yellow);addTriangle(s,tri(110,190,90,70),colors.green);addLine(s,190,30,190,190,colors.violet,10);return s;}});
      o.push({correct:false, svg:()=>{const s=drawBase();addRect(s,60,70,100,70,colors.yellow);addTriangle(s,tri(110,190,90,70),colors.green);addLine(s,30,30,30,190,colors.violet,10);return s;}});
      o.push({correct:false, svg:()=>{const s=drawBase();addRect(s,60,70,100,70,colors.yellow);addTriangle(s,tri(110,80,90,70),colors.green);addLine(s,190,30,190,190,colors.violet,10);return s;}});
      return shuffle(o);
    }},
  { kind:"image", prompt:"",
    tts:"W√§hle das Bild mit einem blauen Kreis unten rechts, einer orangen waagrechten Linie oben und einem kleinen gr√ºnen Quadrat unten links.",
    buildOptions:function(){ const o=[];
      o.push({correct:true, svg:()=>{const s=drawBase();addCircle(s,165,165,30,colors.blue);addLine(s,30,40,190,40,colors.orange,10);addRect(s,40,160,30,30,colors.green);return s;}});
      o.push({correct:false, svg:()=>{const s=drawBase();addCircle(s,165,55,30,colors.blue);addLine(s,30,40,190,40,colors.orange,10);addRect(s,40,160,30,30,colors.green);return s;}});
      o.push({correct:false, svg:()=>{const s=drawBase();addCircle(s,165,165,30,colors.blue);addLine(s,30,180,190,180,colors.orange,10);addRect(s,40,160,30,30,colors.green);return s;}});
      return shuffle(o);
    }},
  { kind:"image", prompt:"",
    tts:"Suche das Bild mit einem violetten Kreis in der Mitte, einer gelben Diagonale von oben rechts nach unten links und dem Buchstaben A links oben.",
    buildOptions:function(){ const o=[];
      o.push({correct:true, svg:()=>{const s=drawBase();addCircle(s,110,110,34,colors.violet);addLine(s,180,30,30,180,colors.yellow,10);addText(s,20,30,"A","#1f2937",26,"800");return s;}});
      o.push({correct:false, svg:()=>{const s=drawBase();addCircle(s,110,110,34,colors.violet);addLine(s,30,30,180,180,colors.yellow,10);addText(s,20,30,"A","#1f2937",26,"800");return s;}});
      o.push({correct:false, svg:()=>{const s=drawBase();addCircle(s,110,110,34,colors.violet);addLine(s,180,30,30,180,colors.yellow,10);addText(s,20,30,"B","#1f2937",26,"800");return s;}});
      return shuffle(o);
    }},
  { kind:"image", prompt:"",
    tts:"W√§hle das Bild mit zwei gr√ºnen senkrechten Linien links, einem roten Dreieck oben und einem blauen Quadrat rechts unten.",
    buildOptions:function(){ const tri=(cx,cy,w,h)=>`${cx-w/2},${cy} ${cx+w/2},${cy} ${cx},${cy-h}`; const o=[];
      o.push({correct:true, svg:()=>{const s=drawBase();addLine(s,40,40,40,180,colors.green,10);addLine(s,70,40,70,180,colors.green,10);addTriangle(s,tri(110,80,80,60),colors.red);addRect(s,150,150,40,40,colors.blue);return s;}});
      o.push({correct:false, svg:()=>{const s=drawBase();addLine(s,150,40,150,180,colors.green,10);addLine(s,180,40,180,180,colors.green,10);addTriangle(s,tri(110,80,80,60),colors.red);addRect(s,150,150,40,40,colors.blue);return s;}});
      o.push({correct:false, svg:()=>{const s=drawBase();addLine(s,40,40,40,180,colors.green,10);addLine(s,70,40,70,180,colors.green,10);addTriangle(s,tri(110,80,80,60),colors.red);addRect(s,30,150,40,40,colors.blue);return s;}});
      return shuffle(o);
    }}
];

// 2 Bild schwer
const imageHard=[
  { kind:"image", prompt:"",
    tts:"Suche das Bild mit zwei gelben Quadraten, oben links und unten rechts. Dazwischen verl√§uft eine violette Diagonale von unten links nach oben rechts.",
    buildOptions:function(){ const o=[];
      o.push({correct:true, svg:()=>{const s=drawBase();addRect(s,40,40,36,36,colors.yellow);addRect(s,150,150,36,36,colors.yellow);addLine(s,30,190,190,30,colors.violet,10);return s;}});
      o.push({correct:false, svg:()=>{const s=drawBase();addRect(s,40,150,36,36,colors.yellow);addRect(s,150,40,36,36,colors.yellow);addLine(s,30,190,190,30,colors.violet,10);return s;}});
      o.push({correct:false, svg:()=>{const s=drawBase();addRect(s,40,40,36,36,colors.yellow);addRect(s,150,150,36,36,colors.yellow);addLine(s,30,30,190,190,colors.violet,10);return s;}});
      return shuffle(o);
    }},
  { kind:"image", prompt:"",
    tts:"W√§hle das Bild mit einem gr√ºnen Kreis oben rechts, einem roten Dreieck unten links und einer blauen waagrechten Linie in der Mitte.",
    buildOptions:function(){ const tri=(cx,cy,w,h)=>`${cx-w/2},${cy} ${cx+w/2},${cy} ${cx},${cy-h}`; const o=[];
      o.push({correct:true, svg:()=>{const s=drawBase();addCircle(s,170,50,24,colors.green);addTriangle(s,tri(60,180,80,60),colors.red);addLine(s,30,110,190,110,colors.blue,10);return s;}});
      o.push({correct:false, svg:()=>{const s=drawBase();addCircle(s,50,50,24,colors.green);addTriangle(s,tri(60,180,80,60),colors.red);addLine(s,30,110,190,110,colors.blue,10);return s;}});
      o.push({correct:false, svg:()=>{const s=drawBase();addCircle(s,170,50,24,colors.green);addTriangle(s,tri(60,80,80,60),colors.red);addLine(s,30,110,190,110,colors.blue,10);return s;}});
      return shuffle(o);
    }}
];

// 8 MCQ (3 aktualisierte + 5 neue)
const mcqScenarios=[
  { kind:"mcq", prompt:"Welche Aussage ist korrekt?",
    tts:"Orion eins, bitte vor Rollweg November warten.",
    options:[
      {text:"Orion 1 muss vor dem Standplatz November warten.", correct:false},
      {text:"Orion 1 muss nach Rollweg November warten.", correct:false},
      {text:"Orion 1 muss vor Rollweg November warten.", correct:true}
    ]},
  { kind:"mcq", prompt:"Welche Aussage ist korrekt?",
    tts:"Zebra S√ºd, bitte zu Alfa zehn fahren. Wir haben eine St√∂rung.",
    options:[
      {text:"Zebra S√ºd soll zu A2 fahren. Dort gibt es ein Problem.", correct:false},
      {text:"Zebra S√ºd soll nicht zu A10 fahren.", correct:false},
      {text:"Zebra S√ºd soll zu A10 fahren. Dort gibt es ein Problem.", correct:true}
    ]},
  { kind:"mcq", prompt:"Welche Aussage ist korrekt?",
    tts:"Gusti zwei, kannst du bitte zum Tower kommen?",
    options:[
      {text:"Gusti 2 soll nicht zum Tower kommen.", correct:false},
      {text:"Gusti 2 soll sp√§ter zum Tower kommen.", correct:false},
      {text:"Gusti 2 soll zum Tower kommen.", correct:true}
    ]},
  { kind:"mcq", prompt:"Welche Aussage ist korrekt?",
    tts:"Traktor Alfa siebzehn, ich kann dich kaum verstehen.",
    options:[
      {text:"Traktor A17 hat falsch gestossen.", correct:false},
      {text:"Traktor A17 ist schlecht zu verstehen.", correct:true},
      {text:"Traktor A17 versteht man sehr gut.", correct:false}
    ]},
  { kind:"mcq", prompt:"Welche Aussage ist korrekt?",
    tts:"Falls niemand widerspricht, gilt der Vorschlag automatisch als angenommen.",
    options:[
      {text:"Nur wenn alle zustimmen, ist der Vorschlag angenommen.", correct:false},
      {text:"Wenn niemand widerspricht, ist der Vorschlag automatisch g√ºltig.", correct:true},
      {text:"Der Vorschlag ist nur g√ºltig, wenn einer widerspricht.", correct:false}
    ]},
  { kind:"mcq", prompt:"Welche Aussage ist korrekt?",
    tts:"Sobald die Arbeiten beendet sein werden, kann mit der Nutzung begonnen werden.",
    options:[
      {text:"Die Arbeiten haben nie begonnen.", correct:false},
      {text:"Man kann w√§hrend den Arbeiten schon benutzen.", correct:false},
      {text:"Man darf erst anfangen, wenn die Arbeiten abgeschlossen sind.", correct:true}
    ]},
  { kind:"mcq", prompt:"Welche Aussage ist korrekt?",
    tts:"Gusti 2, die Funkverbindung ist schlecht. Wiederhole die letzte Meldung nochmals.",
    options:[
      {text:"Gusti 2 soll das Funken einstellen.", correct:false},
      {text:"Gusti 2 soll die letzte Meldung wiederholen.", correct:true},
      {text:"Gusti 2 soll keine Meldung wiederholen.", correct:false}
    ]},
  { kind:"mcq", prompt:"Welche Aussage ist korrekt?",
    tts:"Es wurde eine Blitzschlagwarnung herausgegeben.",
    options:[
      {text:"Es k√∂nnte in der n√§chsten Zeit stark regnen.", correct:false},
      {text:"Es ist nicht mit Blitz und Donner zu rechnen.", correct:false},
      {text:"Es k√∂nnte zu Blitzen und Donner kommen.", correct:true}
    ]}
];

// Finaler Test: 5 + 2 + 8 = 15
const testScenariosAll=[...imageBase,...imageHard,...mcqScenarios];

// √úbung: 2 (aus Original)
const practiceScenarios=[
  { kind:"image", prompt:"Ein roter Kreis in der Mitte.",
    tts:"Suche das Bild mit einem roten Kreis in der Mitte.",
    buildOptions:function(){ const o=[];
      o.push({correct:true, svg:()=>{const s=drawBase();addCircle(s,110,110,32,colors.red);return s;}});
      o.push({correct:false, svg:()=>{const s=drawBase();addCircle(s,110,110,32,colors.blue);return s;}});
      o.push({correct:false, svg:()=>{const s=drawBase();addCircle(s,170,170,32,colors.red);return s;}});
      return shuffle(o);
    }},
  { kind:"mcq", prompt:"",
    tts:"Traktor Alfa siebzehn, bitte warten.",
    options:[
      {text:"Traktor A17 muss warten.", correct:true},
      {text:"Traktor A17 muss nicht warten.", correct:false},
      {text:"Traktor A17 meldet eine St√∂rung.", correct:false}
    ]}
];

// ---------- state ----------
let started=false,index=0,score=0,playsUsed=0,selected=-1,timer=null,timeLeft=TIME_LIMIT;
let presented=null; const answers=[]; let testScenarios=[];
let p_index=0,p_selected=-1,p_timer=null,p_timeLeft=TIME_LIMIT,p_playsUsed=0,p_presented=null;

// ---------- get DOM ----------
const startCard=document.getElementById('startCard');
const practiceCard=document.getElementById('practiceCard');
const quizCard=document.getElementById('quizCard');
const summaryCard=document.getElementById('summaryCard');

const p_play=document.getElementById('p_play');
const p_submit=document.getElementById('p_submit');
const p_next=document.getElementById('p_next');
const p_timeBar=document.getElementById('p_timeBar');
const p_timeLeftEl=document.getElementById('p_timeLeft');
const p_playsLeftEl=document.getElementById('p_playsLeft');
const p_idxEl=document.getElementById('p_idx');
const p_totalEl=document.getElementById('p_total');
const p_prompt=document.getElementById('p_prompt');
const p_imageChoices=document.getElementById('p_imageChoices');
const p_mcqChoices=document.getElementById('p_mcqChoices');
const p_feedback=document.getElementById('p_feedback');
const toTestBtn=document.getElementById('toTestBtn');

const idxEl=document.getElementById('idx');
const scoreEl=document.getElementById('score');
const playsLeftEl=document.getElementById('playsLeft');
const timeLeftEl=document.getElementById('timeLeft');
const timeBar=document.getElementById('timeBar');
const playBtn=document.getElementById('play');
const submitBtn=document.getElementById('submit');
const nextBtn=document.getElementById('next');
const promptEl=document.getElementById('prompt');
const feedbackEl=document.getElementById('feedback');
const imageChoices=document.getElementById('imageChoices');
const mcqChoices=document.getElementById('mcqChoices');
const detailList=document.getElementById('detailList');
const totalEl=document.getElementById('total');

// ---------- Settings modal ----------
const openSettingsBtn=document.getElementById('openSettings');
const settingsBackdrop=document.getElementById('settingsBackdrop');
const closeSettingsBtn=document.getElementById('closeSettings');
const voiceSelect=document.getElementById('voiceSelect');
const rate=document.getElementById('rate');
const pitch=document.getElementById('pitch');
const rateVal=document.getElementById('rateVal');
const pitchVal=document.getElementById('pitchVal');
const testVoiceBtn=document.getElementById('testVoice');
const saveVoiceBtn=document.getElementById('saveVoice');

function openModal(){ settingsBackdrop.style.display='flex'; }
function closeModal(){ settingsBackdrop.style.display='none'; }

openSettingsBtn.addEventListener('click', ()=>{
  openModal();
  populateVoiceSelect().catch(()=>{});
  const pref = loadPref() || {rate:1.0,pitch:1.0};
  rate.value=pref.rate??1.0; pitch.value=pref.pitch??1.0;
  rateVal.textContent=(pref.rate??1.0).toFixed(2);
  pitchVal.textContent=(pref.pitch??1.0).toFixed(2);
});
closeSettingsBtn.addEventListener('click', closeModal);

rate.addEventListener('input', e=> rateVal.textContent=parseFloat(e.target.value).toFixed(2));
pitch.addEventListener('input', e=> pitchVal.textContent=parseFloat(e.target.value).toFixed(2));

testVoiceBtn.addEventListener('click', async ()=>{
  const name=voiceSelect.value;
  const r=parseFloat(rate.value||"1.0"), p=parseFloat(pitch.value||"1.0");
  const u=new SpeechSynthesisUtterance("Dies ist eine Testansage f√ºr die gew√§hlte Stimme.");
  u.lang='de-DE';
  const vs= speechSynthesis?.getVoices?.()||[];
  const v=vs.find(v=>v.name===name); if(v) u.voice=v;
  u.rate=r; u.pitch=p;
  try{ speechSynthesis.cancel(); }catch{}
  speechSynthesis?.speak?.(u);
});

saveVoiceBtn.addEventListener('click', async ()=>{
  savePref({name:voiceSelect.value, rate:parseFloat(rate.value||"1.0"), pitch:parseFloat(pitch.value||"1.0")});
  cachedDeVoice=null; await getDeVoice();
  closeModal();
});

async function populateVoiceSelect(){
  const vs = await awaitVoices();
  const de = vs.filter(v => (v.lang||"").toLowerCase().startsWith("de"));
  const rest = vs.filter(v => !(v.lang||"").toLowerCase().startsWith("de"));
  const ordered=[...de,...rest];
  voiceSelect.innerHTML="";
  if(!ordered.length){ const opt=document.createElement('option'); opt.textContent="Keine Stimmen verf√ºgbar"; opt.value=""; voiceSelect.appendChild(opt); return; }
  ordered.forEach(v=>{ const opt=document.createElement('option'); opt.value=v.name; opt.textContent=`${v.name} ‚Äî ${v.lang}`; voiceSelect.appendChild(opt); });
  const saved=loadPref(); const picked = saved ? ordered.find(v=>v.name===saved.name) : null;
  voiceSelect.value = picked ? picked.name : (de[0]?.name || ordered[0].name);
}

// ---------- Practice ----------
function startPractice(){
  startCard.classList.add('hidden'); summaryCard.classList.add('hidden');
  practiceCard.classList.remove('hidden');
  p_index=0; p_selected=-1; p_playsUsed=0; p_presented=null;
  p_totalEl.textContent=practiceScenarios.length;
  renderPractice();
}
function p_startTimer(){
  if(p_timer) clearInterval(p_timer);
  p_timeLeft=TIME_LIMIT; p_timeLeftEl.textContent=`${p_timeLeft}s`; p_timeBar.style.width='100%'; p_timeBar.classList.remove('warn');
  p_timer=setInterval(()=>{
    p_timeLeft--; p_timeLeftEl.textContent=`${p_timeLeft}s`; p_timeBar.style.width=`${(p_timeLeft/TIME_LIMIT)*100}%`;
    p_timeBar.classList.toggle('warn', p_timeLeft<=10 && p_timeLeft>0);
    if(p_timeLeft<=0){ clearInterval(p_timer); p_lockInputs(); p_next.disabled=false; }
  },1000);
}
function p_lockInputs(){ p_play.disabled=true; p_submit.disabled=true; Array.from(practiceCard.querySelectorAll('.opt, .mcq .choice')).forEach(el=>el.style.pointerEvents='none'); }
function renderPractice(){
  const s=practiceScenarios[p_index];
  p_idxEl.textContent=p_index+1; p_feedback.innerHTML=""; p_selected=-1; p_next.disabled=true;
  p_imageChoices.classList.add('hidden'); p_mcqChoices.classList.add('hidden'); p_imageChoices.innerHTML=""; p_mcqChoices.innerHTML="";
  p_submit.disabled=false; p_play.disabled=false; p_prompt.textContent=s.prompt||"";
  if(s.kind==="image"){
    const opts=s.buildOptions(); p_presented=opts.map((o,i)=>({text:`Bild ${i+1}`, correct:o.correct}));
    p_imageChoices.classList.remove('hidden');
    opts.forEach((opt,i)=>{
      const card=document.createElement('div'); card.className='opt'; card.tabIndex=0;
      const wrap=document.createElement('div'); wrap.className='svg-wrap'; wrap.appendChild(opt.svg());
      const label=document.createElement('div'); label.className='label-center'; label.textContent='Bild '+(i+1);
      card.appendChild(wrap); card.appendChild(label);
      const choose=()=>{ Array.from(p_imageChoices.children).forEach(el=>el.classList.remove('selected')); card.classList.add('selected'); p_selected=i; };
      card.addEventListener('click', choose); card.addEventListener('keydown', e=>{ if(e.key==='Enter' || e.key===' '){ e.preventDefault(); choose(); } });
      p_imageChoices.appendChild(card);
    });
  }else{
    p_mcqChoices.classList.remove('hidden');
    const shuffled=shuffle(s.options.map(o=>({text:o.text, correct:o.correct}))); p_presented=shuffled;
    shuffled.forEach((opt,i)=>{
      const id=`pm${p_index}_${i}`;
      const label=document.createElement('label'); label.className='choice'; label.setAttribute('for', id);
      label.innerHTML=`<input id="${id}" type="radio" name="pmcq"> <div>${opt.text}</div>`;
      const input=label.querySelector('input');
      input.addEventListener('change', ()=>{ Array.from(p_mcqChoices.children).forEach(el=>el.classList.remove('selected')); label.classList.add('selected'); p_selected=i; });
      p_mcqChoices.appendChild(label);
    });
  }
  p_playsUsed=1; p_playsLeftEl.textContent=MAX_PLAYS - p_playsUsed;
  p_startTimer(); setTimeout(()=>playPrompt(s), 0);
}
p_play.addEventListener('click', ()=>{ if(p_playsUsed>=MAX_PLAYS) return; p_playsUsed++; p_playsLeftEl.textContent=Math.max(0,MAX_PLAYS-p_playsUsed); if(p_playsUsed>=MAX_PLAYS) p_play.disabled=true; playPrompt(practiceScenarios[p_index]); });
p_submit.addEventListener('click', ()=>{ if(p_selected<0){ p_feedback.innerHTML=`<div class="result-fail">Bitte eine Option ausw√§hlen.</div>`; return; } p_lockInputs(); p_next.disabled=false; });
p_next.addEventListener('click', ()=>{ if(p_index<practiceScenarios.length-1){ p_index++; renderPractice(); } else { p_feedback.innerHTML=""; toTestBtn.classList.remove('hidden'); } });
toTestBtn.addEventListener('click', startTest);

// ---------- Test ----------
function startTest(){
  testScenarios = shuffle(testScenariosAll.slice());
  started=true; index=0; score=0; playsUsed=0; selected=-1; presented=null; answers.length=0;
  startCard.classList.add('hidden'); practiceCard.classList.add('hidden'); summaryCard.classList.add('hidden'); quizCard.classList.remove('hidden');
  totalEl.textContent=testScenarios.length; renderTest();
}
function startTimer(){
  if(timer) clearInterval(timer);
  timeLeft=TIME_LIMIT; timeLeftEl.textContent=`${timeLeft}s`; timeBar.style.width='100%'; timeBar.classList.remove('warn');
  timer=setInterval(()=>{
    timeLeft--; timeLeftEl.textContent=`${timeLeft}s`; timeBar.style.width=`${(timeLeft/TIME_LIMIT)*100}%`;
    timeBar.classList.toggle('warn', timeLeft<=10 && timeLeft>0);
    if(timeLeft<=0){ clearInterval(timer); autoFailDueToTimeout(); }
  },1000);
}
function stopTimer(){ if(timer){ clearInterval(timer); timer=null; } }
function lockInputs(){ playBtn.disabled=true; submitBtn.disabled=true; Array.from(document.querySelectorAll('.opt, .mcq .choice')).forEach(el=>el.style.pointerEvents='none'); }

function renderTest(){
  const s=testScenarios[index];
  idxEl.textContent=index+1; promptEl.textContent=s.prompt||""; feedbackEl.innerHTML=""; selected=-1; nextBtn.disabled=true;
  imageChoices.classList.add('hidden'); mcqChoices.classList.add('hidden'); imageChoices.innerHTML=""; mcqChoices.innerHTML="";
  submitBtn.disabled=false; playBtn.disabled=false; presented=null;

  if(s.kind==="image"){
    const opts=s.buildOptions(); presented=opts.map((o,i)=>({text:`Bild ${i+1}`, correct:o.correct}));
    imageChoices.classList.remove('hidden');
    opts.forEach((opt,i)=>{
      const card=document.createElement('div'); card.className='opt'; card.tabIndex=0;
      const wrap=document.createElement('div'); wrap.className='svg-wrap'; wrap.appendChild(opt.svg());
      const label=document.createElement('div'); label.className='label-center'; label.textContent='Bild '+(i+1);
      card.appendChild(wrap); card.appendChild(label);
      const choose=()=>{ Array.from(imageChoices.children).forEach(el=>el.classList.remove('selected')); card.classList.add('selected'); selected=i; };
      card.addEventListener('click', choose); card.addEventListener('keydown', e=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); choose(); } });
      imageChoices.appendChild(card);
    });
  }else{
    mcqChoices.classList.remove('hidden');
    const shuffled = shuffle(s.options.map(o=>({text:o.text, correct:o.correct}))); presented=shuffled;
    shuffled.forEach((opt,i)=>{
      const id=`q${index}_${i}`;
      const label=document.createElement('label'); label.className='choice'; label.setAttribute('for', id);
      label.innerHTML=`<input id="${id}" type="radio" name="mcq"> <div>${opt.text}</div>`;
      const input=label.querySelector('input');
      input.addEventListener('change', ()=>{ Array.from(mcqChoices.children).forEach(el=>el.classList.remove('selected')); label.classList.add('selected'); selected=i; });
      mcqChoices.appendChild(label);
    });
  }

  playsUsed=1; playsLeftEl.textContent=MAX_PLAYS-playsUsed;
  startTimer(); setTimeout(()=>playPrompt(s), 0);
}
playBtn.addEventListener('click', ()=>{ if(playsUsed>=MAX_PLAYS) return; playsUsed++; playsLeftEl.textContent=Math.max(0,MAX_PLAYS-playsUsed); if(playsUsed>=MAX_PLAYS) playBtn.disabled=true; playPrompt(testScenarios[index]); });
submitBtn.addEventListener('click', ()=>{
  if(selected<0){ feedbackEl.innerHTML=`<div class="result-fail">Bitte eine Option ausw√§hlen.</div>`; return; }
  const correctIndex=presented.findIndex(o=>o.correct===true);
  const isCorrect=(selected===correctIndex);
  if(!answers.some(a=>a.idx===index)){ if(isCorrect) score++; answers.push({idx:index,isCorrect,selected,correctIndex,presented:presented.slice(),kind:testScenarios[index].kind,prompt:testScenarios[index].prompt}); }
  stopTimer(); lockInputs(); nextBtn.disabled=false; feedbackEl.innerHTML="";
});
function autoFailDueToTimeout(){
  const correctIndex=presented.findIndex(o=>o.correct===true);
  if(!answers.some(a=>a.idx===index)){ answers.push({idx:index,isCorrect:false,selected:-1,correctIndex,presented:presented.slice(),kind:testScenarios[index].kind,prompt:testScenarios[index].prompt}); }
  lockInputs(); nextBtn.disabled=false; feedbackEl.innerHTML="";
}
nextBtn.addEventListener('click', ()=>{ stopTimer(); if(index<testScenarios.length-1){ index++; renderTest(); } else { showSummary(); } });
function showSummary(){
  quizCard.classList.add('hidden'); summaryCard.classList.remove('hidden');
  const total=testScenarios.length; const pct=Math.round((answers.filter(a=>a.isCorrect).length/total)*100); const passed=(pct>=PASS_THRESHOLD*100);
  const box=document.getElementById('summaryBox'); box.className= passed ? 'result-pass' : 'result-fail';
  box.textContent = passed ? `Bestanden üéâ ‚Äì ${pct}% richtig (${answers.filter(a=>a.isCorrect).length}/${total}).` : `Nicht bestanden ‚Äì ${pct}% richtig (${answers.filter(a=>a.isCorrect).length}/${total}). Mindestens ${Math.round(PASS_THRESHOLD*100)}% erforderlich.`;
  detailList.innerHTML="";
  answers.forEach((a,i)=>{
    const div=document.createElement('div'); div.className='list-item';
    const tag=a.isCorrect?'‚úÖ':'‚ùå'; const type=a.kind==="image"?"Bild":"Funk";
    const yourText = (a.selected===-1) ? "‚Äî (keine Antwort)" : (a.presented[a.selected]?.text || "");
    const correctText = a.presented[a.correctIndex]?.text || "";
    div.innerHTML=`<div><b>${tag} Frage ${i+1} (${type})</b> ‚Äì ${a.prompt}<br>
    <span class="muted">Deine Auswahl: ${yourText}</span><br>
    <span class="muted">Richtig: ${correctText}</span></div>`;
    detailList.appendChild(div);
  });
}

// Start/Restart
document.getElementById('practiceBtn').addEventListener('click', startPractice);
document.getElementById('startBtn').addEventListener('click', startTest);
document.getElementById('restart').addEventListener('click', ()=>{ answers.length=0; started=false; index=0; score=0; startCard.classList.remove('hidden'); practiceCard.classList.add('hidden'); quizCard.classList.add('hidden'); summaryCard.classList.add('hidden'); });

// Warm-up Stimmen
getDeVoice().catch(()=>{});
toast('Bereit. √ñffne ggf. ‚öôÔ∏è Audio‚ÄëEinstellungen und starte.');
} catch(e){ console.error(e); toast('Fehler beim Initialisieren: '+e.message); }
}
</script>
</body>
</html>
